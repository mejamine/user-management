- name: Check for running processes for each user
  ansible.builtin.shell: "pgrep -u {{ user_to_delete }}"
  register: user_processes
  ignore_errors: true


- name: Fail if users have running processes
  ansible.builtin.fail:
    msg: "User {{ user_to_delete}} has running processes: {{ user_processes.stdout_lines }}"
  when: user_processes.rc == 0
