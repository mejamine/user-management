- name: Create users
  ansible.builtin.user:
    name: "{{ item.name }}"
    password: "{{ item.password | password_hash('sha512') }}"
    groups: "{{ item.groups | join(',') }}"
    append: true
    shell: /bin/bash
    create_home: true
    state: present
  loop: "{{ users }}"
  when: item.name not in existing_users